pkgname=whirltube-git
pkgver=0.4.7.0.gf8716d9
pkgrel=1
pkgdesc="Lightweight GTK4 frontend for YouTube using mpv and yt-dlp (git)"
arch=('any')
url="https://github.com/tazdev-ops/WhirlTube"
license=('GPL3')
depends=('python' 'gtk4' 'libadwaita' 'python-gobject' 'yt-dlp' 'python-httpx' 'mpv')
optdepends=(
  'python-mpv: in-window (embedded) playback on X11'
  'libnotify: desktop notifications'
  'python-pillow: thumbnail WebP fallback decoding'
)
makedepends=('git' 'python-build' 'python-installer' 'python-hatchling')
provides=('whirltube')
conflicts=('whirltube')
source=("git+https://github.com/tazdev-ops/WhirlTube.git")
sha256sums=('SKIP')

pkgver() {
  cd "WhirlTube"
  # Prefer tags; fall back to commit count + short hash
  git describe --tags --long 2>/dev/null | sed 's/^v//; s/-/./g' \
    || printf "0.0.0.r%s.g%s" "$(git rev-list --count HEAD)" "$(git rev-parse --short HEAD)"
}

build() {
  cd "WhirlTube"
  python -m build --wheel --no-isolation
}

package() {
  cd "WhirlTube"
  python -m installer --destdir="$pkgdir" dist/*.whl

  if [[ -f data/org.whirltube.WhirlTube.desktop ]]; then
    install -Dm644 data/org.whirltube.WhirlTube.desktop \
      "$pkgdir/usr/share/applications/org.whirltube.WhirlTube.desktop"
  else
    install -Dm644 /dev/stdin "$pkgdir/usr/share/applications/org.whirltube.WhirlTube.desktop" <<'EOF'
[Desktop Entry]
Name=WhirlTube
Comment=Lightweight GTK4 frontend for YouTube using mpv and yt-dlp
Exec=whirltube
Icon=whirltube
Terminal=false
Type=Application
Categories=AudioVideo;Network;GTK;
StartupWMClass=org.whirltube.WhirlTube
EOF
  fi

  for sz in 16 24 32 48 64 128 256 512; do
    for f in "src/whirltube/assets/icons/hicolor/${sz}x${sz}/apps/whirltube.png" \
             "src/whirltube/assets/icons/hicolor/${sz}x${sz}/apps/whirltube.svg"; do
      if [[ -f "$f" ]]; then
        install -Dm644 "$f" "$pkgdir/usr/share/icons/hicolor/${sz}x${sz}/apps/whirltube.${f##*.}"
      fi
    done
  done
  if [[ -f src/whirltube/assets/icons/hicolor/scalable/apps/whirltube.svg ]]; then
    install -Dm644 src/whirltube/assets/icons/hicolor/scalable/apps/whirltube.svg \
      "$pkgdir/usr/share/icons/hicolor/scalable/apps/whirltube.svg"
  fi
}
